# ADR_0002 — MVP-0.2 Voltage Drop (ΔU) + section selection

Дата: 2026-02-15  
Статус: Accepted  

## Контекст

Для MVP-0.2 требуется добавить расчёт падения напряжения \(\Delta U\) и подбор минимального сечения
по \(\Delta U\) согласно ГОСТ Р 50571.5.52-2011, Приложение G (справочное), с учётом:

- \(\rho\) (Cu/Al), \(X\)
- \(\cos\varphi\) и \(\sin\varphi\)
- коэффициента \(b\) (1/2)
- \(U_0\) (фаза‑нейтраль)
- увеличения допустимого \(\Delta U\%\) при длине > 100 м:
  0.005%/м сверх 100, но не более +0.5%

Системные принципы проекта неизменны:
- DB = единственный источник истины
- CalcCore независим от CLI
- DWG = только рендер
- константы не выдумывать (только Прил. G)

## Решение

### 1) Модель данных

- Ввод для расчёта \(\Delta U\) хранится в `circuits`.
- Результаты расчёта \(\Delta U\) и выбранного сечения хранятся в `circuit_calc`.
- Список допустимых сечений хранится в `cable_sections`.
- Лимиты \(\Delta U\%\) хранятся на панели:
  - `panels.du_limit_lighting_pct` (default 3.0)
  - `panels.du_limit_other_pct` (default 5.0)
- (опционально) `panels.installation_type` хранится как метаданные, но в MVP-0.2 не влияет на расчёт
  (лимиты полностью задают допустимость).

### 2) \(U_0\) для \(\Delta U\%\)

\(\Delta U\%\) считается относительно \(U_0\) (фаза‑нейтраль), берётся из `panels.u_ph_v`.

### 3) Правило \(L > 100\) м (Прил. G)

Реализуется функцией `effective_du_limit(base_limit_pct, length_m)`:

- если `length_m <= 100`: `effective = base`
- иначе:
  - `add_pct = min(0.005 * (length_m - 100), 0.5)`
  - `effective = base + add_pct`

### 4) Выбор коэффициента \(b\) (1/2)

В MVP-0.2 “полностью несбалансированная 3ф” задаётся флагом на цепи (не вычисляется из фазировки):

- если `circuits.phases == 3` и `circuits.unbalance_mode == 'NORMAL'` → `b = 1`
- иначе → `b = 2`

### 5) Ток `i_calc_a`

Для MVP-0.2 ток берётся **входным полем** `circuits.i_calc_a` и не выводится автоматически из RTM/phase_balance.
Это упрощает реализацию и избегает “умных” допущений на стыке методик.

## Альтернативы

- **Вычислять `i_calc_a` из RTM (Sp/Up) автоматически**: отклонено для MVP-0.2 из-за зависимости от полноты RTM модели
  и потенциальной неоднозначности (1ф/3ф, фазировка, несбалансированность).
- **Определять FULL_UNBALANCED из результатов phase_balance**: отклонено, т.к. добавляет скрытую связь между подсистемами
  и усложняет ввод/объяснимость.
- **Выводить лимиты \(\Delta U\%\) из `installation_type`**: отклонено; лимиты задаются явно и являются контрактом расчёта.

## Последствия

- Появляется отдельный слой расчёта \(\Delta U\) (`calc_core/voltage_drop.py`) и соответствующие таблицы в SQLite.
- CLI (`tools/run_calc.py`) получает режим `--calc-du` для расчёта \(\Delta U\) по всем цепям панели.
- Для корректного подбора сечения требуется seed `cable_sections`.

Ссылки:
- Контракт расчёта: `docs/contracts/VOLTAGE_DROP.md`

