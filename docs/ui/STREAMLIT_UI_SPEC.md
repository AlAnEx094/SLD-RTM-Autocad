# STREAMLIT_UI_SPEC — операторский Streamlit UI (замена Excel)

## 1) Цель интерфейса

Streamlit UI предназначен для инженера‑проектировщика как **операторский интерфейс** к проектной БД SQLite (источник истины) и расчётам (`calc_core/` + `tools/`), чтобы:

- **Вводить исходные данные** в нормализованные таблицы (без прямого редактирования SQL).
- **Визуально контролировать “таблицу нагрузок как в Excel”**: ввод `rtm_rows` + расчёт `rtm_row_calc` + итоги `rtm_panel_calc` в одном экране.
- **Запускать расчёты одной кнопкой** (“Пересчитать”) и видеть **индикатор актуальности** со статусом `OK/STALE/NO_CALC/UNKNOWN` (сравнение `updated_at` в calc‑таблицах с UI‑метками изменений ввода).
- **Экспортировать артефакты для DWG** без AutoCAD API:
  - JSON payload (контракт v0.4): `tools/export_payload.py` / `calc_core.export_payload.build_payload`
  - CSV атрибутов (маппинг v0.5): `tools/export_attributes_csv.py` + `dwg/mapping_v0_5.yaml` (не модифицируется UI)
- **Минимизировать возможность “сломать БД”**: транзакции, подтверждения удаления, безопасные дефолты, блокировки опасных действий, read‑only режимы.

Фокус MVP‑UI v0.2 — эксплуатационная пригодность: пошаговый мастер, **единый экран таблицы нагрузок**, строгая валидация и прозрачный индикатор актуальности расчётов.

Не цель: визуализация DWG/AutoCAD, работа с AutoCAD API, “красивая витрина”.

## 2) Пользовательские сценарии (минимум 5)

### Сценарий 1 — Быстро создать щит и посчитать РТМ
1. Открыть/выбрать файл БД.
2. В “Мастере добавления” создать `panels` (имя, тип 1PH/3PH, напряжения, лимиты ΔU).
3. На странице “РТМ → Единая таблица нагрузок” добавить строки `rtm_rows` (как Excel‑таблица).
4. Нажать “Пересчитать РТМ”.
5. Убедиться, что итоги `rtm_panel_calc` обновились (`updated_at`) и значения адекватны.

### Сценарий 2 — Массовая правка Ki / n / Pn по группе и повторный расчёт
1. Открыть щит.
2. Отфильтровать строки `rtm_rows` по имени/подгруппе.
3. Массово изменить `ki` или `n` в таблице (копипаст диапазона).
4. Валидация подсветит ошибки (например `ki` не число).
5. Нажать “Пересчитать РТМ” и убедиться, что расчётные колонки обновились.

### Сценарий 3 — Контроль актуальности расчётов и “что не посчитано”
1. Открыть щит.
2. На “Дашборде щита” увидеть статусы `OK/STALE/NO_CALC/UNKNOWN`:
   - РТМ (и фазировка для 1PH)
   - ΔU по цепям
   - Секции шин (NORMAL/RESERVE)
3. Если статус `STALE`/`NO_CALC` — нажать “Пересчитать” (кнопка видна рядом со статусом).

### Сценарий 4 — Экспорт для DWG “как есть”, без риска модификации БД
1. Открыть щит и убедиться, что РТМ рассчитан и статус `OK` (иначе экспорт заблокирован).
2. На странице “Экспорт” выбрать:
   - JSON payload v0.4 в файл
   - CSV атрибутов v0.5 в папку `out/`
3. UI выполняет экспорт через read‑only соединение к SQLite (или CLI, который использует `mode=ro`).
4. Пользователь получает пути к созданным файлам и краткое резюме.

### Сценарий 5 — Подготовить секции шин и нагрузки потребителей (NORMAL/RESERVE)
1. Создать/отредактировать `bus_sections` для щита.
2. Создать `consumers` с `load_ref_type`:
   - `RTM_PANEL` (ссылка на `rtm_panel_calc` другого/этого щита)
   - `MANUAL` (ручные P/Q/S/I)
3. Привязать `consumer_feeds` к секциям шин и ролям `NORMAL/RESERVE`.
4. Нажать “Агрегировать по секциям” → заполнится/обновится `section_calc` (с `updated_at`).

### Сценарий 6 — Безопасное удаление (с подтверждением и предпросмотром)
1. Пользователь решает удалить щит/цепь/строку РТМ.
2. UI показывает “что будет удалено каскадно” (кол-во строк в зависимых таблицах).
3. Требуется явное подтверждение (ввод текста/галка/двойной клик).
4. Операция выполняется транзакционно; при ошибке — откат.

## 3) Структура навигации (страницы/вкладки)

### Глобальные страницы
- **0. Подключение к БД**
  - выбор файла SQLite
  - проверка/применение миграций (аналог `tools/run_calc.ensure_migrations`)
  - режимы: `READ_ONLY` / `EDIT` (переключатель, по умолчанию READ_ONLY)
- **1. Обзор проекта**
  - список щитов (`panels`)
  - быстрый поиск/фильтр по имени/типу
  - показатели: сколько щитов, строк РТМ, цепей, потребителей
- **2. Мастер добавления (Wizard)**
  - шаг 1: создать/выбрать щит
  - шаг 2: добавить строки РТМ
  - шаг 3: (опц.) добавить цепи ΔU
  - шаг 4: (опц.) секции шин + потребители
  - шаг 5: расчёт и экспорт

### Страницы внутри выбранного щита (panel_id выбран в сайдбаре)
- **3. Щит → Настройки**
- **4. РТМ → Единая таблица нагрузок (Unified Load Table)**
- **5. РТМ → Итоги и контроль**
- **6. Цепи (ΔU)**
- **7. Секции шин и потребители**
- **8. Экспорт (JSON/CSV для DWG)**
- **9. Администрирование (опасная зона)**

### 3.1 Мастер добавления (Wizard) — пошаговый поток v0.2
Цель мастера — провести инженера через **минимально безопасный** путь: ввод → контроль → расчёт → экспорт.
Мастер — это **надстройка над основными страницами**, без отдельной бизнес‑логики.

Шаги и правила доступности:
1) **Подключение к БД**
   - Ввод: путь к SQLite (обязательный), режим `READ_ONLY`/`EDIT`.
   - Кнопка **Далее** активна только при валидном пути и успешной проверке миграций.
2) **Щит (panels)**
   - Обязательные поля: `name`, `system_type`.
   - Для `3PH`: `u_ll_v > 0` обязательно; `u_ph_v` — опционально.
   - Для `1PH`: обязателен `u_ph_v > 0` **или** `u_ll_v > 0` (см. правила ниже).
   - **Далее** активна только при валидных полях.
3) **РТМ — ввод строк (rtm_rows)**
   - Таблица редактируемых строк с валидацией (см. раздел 4.0).
   - Кнопка **Сохранить ввод** обязательна; **Далее** активна только после успешного сохранения и отсутствия ошибок.
4) **Цепи ΔU (опционально)**
   - Можно пропустить; **Пропустить** доступна всегда.
   - Если вводятся цепи — действуют валидации и блокировки из раздела 6.
5) **Секции шин + потребители (опционально)**
   - Можно пропустить; **Пропустить** доступна всегда.
   - Если вводятся данные — действуют валидации и блокировки из раздела 7.
6) **Расчёт и экспорт**
   - Кнопка **Пересчитать РТМ** активна только при отсутствии ошибок и после сохранения ввода.
   - Для `system_type='1PH'` после РТМ доступна кнопка **Фазировка**.
   - **Экспорт JSON/CSV** активен только при статусе `OK` по РТМ (подробно — раздел 5).
   - Результат шага: ссылки на файлы экспорта + краткий отчёт.


## 4) Состав таблиц на каждой странице (колонки, форматы, валидация)

Ниже описаны таблицы **SQLite** из `db/schema.sql`. UI НЕ должен позволять пользователю “случайно” отредактировать расчётные таблицы.

### 4.0 Строгие правила валидации и блокировок (v0.2)
Валидация выполняется **до сохранения** и применяется на уровне строк/форм. Формулы не вычисляются в UI.

#### 4.0.1 Правила для `panels` (уровень щита)
- `name`: required, непустая строка.
- `system_type`: required, только `3PH|1PH`.
- Напряжения по типу системы:
  - `system_type='3PH'` → `u_ll_v > 0` **обязательно** для расчёта РТМ.
  - `system_type='1PH'` → `u_ph_v > 0` **или** `u_ll_v > 0` (в этом случае для расчёта используется `u_ph_v = u_ll_v / sqrt(3)`; UI показывает предупреждение).
- `u_ph_v`: требуется для расчёта ΔU; при `u_ph_v <= 0` блокировать расчёт ΔU.
- `du_limit_lighting_pct`, `du_limit_other_pct`: required, `>= 0`.

#### 4.0.2 Правила для `rtm_rows` (уровень строки)
- `name`: required, непустая строка.
- `n`: integer, `> 0`.
- `pn_kw`: number, `>= 0`.
- `ki`: number, finite; при `ki < 0.10` или `ki > 0.80` — **warning** (расчёт сделает clamp).
- `cos_phi`: если задан, то `0 < cos_phi <= 1` (иначе ошибка, блокирует расчёт).
- `tg_phi`: если задан, то `>= 0` и finite (иначе ошибка).
- `phases`: enum `1|3`.
- `phase_mode`: enum `AUTO|FIXED|NONE`.
- Связь `phases` ↔ `phase_mode`:
  - если `phases = 3` → `phase_mode = 'NONE'` и `phase_fixed = NULL` (строго).
  - если `phases = 1`:
    - `phase_mode = 'FIXED'` → `phase_fixed` обязателен (`A|B|C`);
    - `phase_mode = 'AUTO'` → `phase_fixed` должен быть `NULL`;
    - `phase_mode = 'NONE'` допустим, но помечается как **warning** (строка исключается из фазировки).

#### 4.0.3 Блокировки кнопок (Save / Calc / Export)
- **Сохранить**: доступно только в `EDIT` и только при отсутствии ошибок валидации.
- **Пересчитать РТМ**: доступно, если нет ошибок и **нет несохранённых изменений** (иначе сообщение “Сохраните изменения”).
- **Фазировка (1PH)**: доступна только после успешного расчёта РТМ и при отсутствии ошибок/несохранённых изменений.
- **Рассчитать ΔU**: блокируется при ошибках в `circuits` или при `u_ph_v <= 0`.
- **Экспорт JSON/CSV**: доступен **только** при статусе РТМ `OK` (нет `NO_CALC`, нет `STALE/UNKNOWN`, нет ошибок валидации).  
  Если статус `STALE/UNKNOWN` — экспорт по умолчанию заблокирован; допускается явное подтверждение “Экспортировать несмотря на неактуальность”.

### 3. Щит → Настройки (`panels`)

**Таблица/форма**: `panels` (редактируемые поля), 1 запись на `panel_id`.

Колонки (edit):
- `name` (TEXT, required): строка, не пустая.
- `system_type` (TEXT, required): enum `3PH|1PH`.
- `u_ll_v` (REAL, optional): \(>0\) для 3PH (иначе расчёт РТМ выдаёт ошибку при расчёте тока).
- `u_ph_v` (REAL, optional): \(>0\), нужен для ΔU (\(U_0\)).
- `du_limit_lighting_pct` (REAL, required, default 3.0): \(>=0\).
- `du_limit_other_pct` (REAL, required, default 5.0): \(>=0\).
- `installation_type` (TEXT, optional): свободный текст/enum проекта (только хранение; без расчётной логики).

Колонки (read‑only):
- `id` (TEXT GUID): показывать, но не редактировать (кнопка “копировать GUID”).

Валидация/подсказки:
- Если `system_type='3PH'` и `u_ll_v` пустой/<=0 → блокировать “Пересчитать РТМ”.
- Если `system_type='1PH'` и `u_ph_v` пустой/<=0 **и** `u_ll_v` пустой/<=0 → блокировать “Пересчитать РТМ”.
- Для ΔU: если в щите есть `circuits`, но `u_ph_v` пустой/<=0 → блокировать “Рассчитать ΔU”.

### 4. РТМ → Единая таблица нагрузок (Unified Load Table) (`rtm_rows` + `rtm_row_calc` + `rtm_panel_calc`)

**Единая страница** объединяет ввод и контроль:
1) **Шапка щита** (panel header/settings): `name`, `system_type`, `u_ll_v`, `u_ph_v`, лимиты ΔU.  
   - В режиме READ_ONLY — только просмотр.  
   - В EDIT — редактирование с валидацией из 4.0.1.
2) **Индикатор актуальности РТМ**: бейдж `OK/STALE/NO_CALC/UNKNOWN` + tooltip + кнопка “Пересчитать”.
3) **Таблица `rtm_rows` (editable)** со встроенными **calc‑колонками** из `rtm_row_calc` (read‑only).
4) **Сводка `rtm_panel_calc` (read‑only)**: компактный блок справа/снизу, дублируется в “итоговой строке”.
5) **Панель действий**: `Сохранить`, `Пересчитать РТМ`, `Фазировка (1PH)`, `Экспорт`.

**Главная таблица на странице**: “строки нагрузок” как единый dataset:

- Источник ввода: `rtm_rows`
- Расчёт по строкам: `rtm_row_calc` (LEFT JOIN по `rtm_rows.id = rtm_row_calc.row_id`)
- Итоги по щиту: `rtm_panel_calc` (1 строка на `panel_id`, выводится отдельным блоком + “итоговой строкой”)

Колонки (ввод, editable; хранятся в `rtm_rows`):
- `name` (TEXT, required): наименование группы/приёмника.
- `n` (INTEGER, required): \(n>0\). UI должен запрещать 0/отрицательные.
- `pn_kw` (REAL, required): \(>=0\).
- `ki` (REAL, required): число (UI валидирует “finite”), но clamp по контракту Kr делается в расчёте; в UI подсветка диапазона:
  - “предупреждение” если \(ki<0.10\) или \(ki>0.80\) (расчёт всё равно зажмёт).
- `cos_phi` (REAL, optional): рекомендуемый диапазон \(0<cos\_phi\le 1\); если задан и вне диапазона — ошибка/блокировка расчёта РТМ.
- `tg_phi` (REAL, optional): если пустой, расчёт берёт из `cos_phi` или 0.0; UI показывает подсказку.
- `phases` (INTEGER, required): enum `1|3`.
- `phase_mode` (TEXT, required): enum `AUTO|FIXED|NONE`.
- `phase_fixed` (TEXT, optional): enum `A|B|C`, **обязателен если** `phase_mode='FIXED'`, иначе должен быть пустым.

Колонки (calc, read‑only; из `rtm_row_calc`):
- `pn_total` (REAL): \(n \cdot pn\_kw\)
- `ki_pn` (REAL): \(ki \cdot pn\_total\)
- `ki_pn_tg` (REAL)
- `n_pn2` (REAL)

Системные колонки (UI, не в БД):
- `row_status`:
  - `OK` (есть calc)
  - `NO_CALC` (нет строки в `rtm_row_calc`)
  - `INVALID` (ошибка валидации ввода)

Итоги (из `rtm_panel_calc`, read‑only, отображать сверху и/или снизу):
- `pp_kw`, `qp_kvar`, `sp_kva`, `ip_a`, `kr`, `ne`
- `updated_at` (TEXT): “РТМ рассчитан: …”

Итоговая строка/панель:
- Показать суммы по вводу: \(\sum pn\_total\), \(\sum ki\_pn\) и т.д. (как “итоги в Excel”).
- Отдельно показать расчётные итоги из `rtm_panel_calc` (истина расчёта).

Кнопки:
- **Сохранить изменения ввода** (только в режиме EDIT; транзакционно).
- **Пересчитать РТМ** (вызывает `tools/run_calc.py` без `--calc-du/--calc-sections` или прямой вызов `calc_core.rtm_f636.run_panel_calc`; для `system_type='1PH'` после этого запускать `calc_core.phase_balance.balance_panel`; см. раздел “Безопасность данных”).
 - **Экспорт** (переход на страницу “Экспорт” или запуск экспорта из этого же экрана; доступность по правилам 4.0.3 и 5.3).

Ключевая UX‑идея “как Excel”:
- Таблица на весь экран, фиксированная первая колонка `name` (или “имя+позиция”), быстрый поиск, фильтр, сортировка.
- Форматирование чисел: kW/kvar/kVA (2 знака), A (1 знак).

Актуальность:
- Для РТМ‑экрана **обязательно** показывать статус `OK/STALE/NO_CALC/UNKNOWN` и кнопку “Пересчитать” при `STALE`/`NO_CALC`.
- Правила статусов и механизм отслеживания изменений ввода см. в разделе **5) UX‑правила → Актуальность расчётов**.

### 5. РТМ → Итоги и контроль (`rtm_panel_calc`, `kr_table` как справка)

Блоки:
- **Итоги РТМ** (read‑only): поля из `rtm_panel_calc`.
- **Фазировка (только для 1PH)**: поля из `panel_phase_calc` (read‑only):
  - `ia_a`, `ib_a`, `ic_a`, `imax_a`, `iavg_a`, `unbalance_pct`, `updated_at`
  - статус `OK/STALE/NO_CALC/UNKNOWN` по правилам раздела **5) UX‑правила → Актуальность расчётов**
- **Контрольные проверки** (UI‑проверки):
  - `pp_kw >= max(pn_kw)` (как реализовано в `calc_core/rtm_f636.py`)
  - `ne` > 0
  - `kr` присутствует (иначе расчёт должен падать — UI показывает текст ошибки последнего запуска)
- **Справка Kr** (read‑only, опционально): просмотр таблицы `kr_table` с фильтрами по `ne`, `ki`, `source` (только просмотр; редактирование запрещено).

### 6. Цепи (ΔU) (`circuits` + `circuit_calc` + `cable_sections`)

Таблица “цепи” (editable в режиме EDIT; ввод в `circuits`):
- `name` (TEXT, optional): рекомендуется сделать required на уровне UI для удобства.
- `phases` (INTEGER, required): `1|3`.
- `neutral_present` (INTEGER, required): `0|1` (checkbox).
- `unbalance_mode` (TEXT, required): `NORMAL|FULL_UNBALANCED`.
- `length_m` (REAL, required): \(>=0\).
- `material` (TEXT, required): `CU|AL`.
- `cos_phi` (REAL, required): \(0 \le cos\_phi \le 1\).
- `load_kind` (TEXT, required): `LIGHTING|OTHER`.
- `i_calc_a` (REAL, required): \(>=0\).

Колонки calc (read‑only, из `circuit_calc`, LEFT JOIN по `circuits.id`):
- `du_v`, `du_pct`, `du_limit_pct`, `s_mm2_selected`, `method`, `updated_at`
- `calc_status`:
  - `OK` если есть `circuit_calc`
  - `NO_CALC` если нет `circuit_calc` (как в контракте DWG payload v0.4)

Кнопки:
- **Сохранить изменения цепей** (транзакционно).
- **Рассчитать ΔU для щита**:
  - если `cable_sections` пуст, предложить “засидить стандартные сечения” (только через штатный seed, без ручного ввода).
  - запускать `calc_core.voltage_drop.calc_panel_du` (или `tools/run_calc.py --calc-du`).

Актуальность:
- Показывать статус `OK/STALE/NO_CALC/UNKNOWN` по правилам раздела **5) UX‑правила → Актуальность расчётов**.
- При `STALE/NO_CALC/UNKNOWN` кнопка “Рассчитать ΔU” доступна и выделена как рекомендуемая.

Валидации/блокировки:
- Блокировать “Рассчитать ΔU”, если `panels.u_ph_v` отсутствует/<=0.
- Подсветка превышения лимита: если `du_pct > du_limit_pct` (красный).
- Подсветка метода `...MAX_SECTION` как предупреждение (жёлтый): лимит не достигнут даже на максимальном сечении.

### 7. Секции шин и потребители (`bus_sections`, `consumers`, `consumer_feeds`, `section_calc`)

#### 7.1 Секции шин (`bus_sections`)
Таблица (editable):
- `name` (TEXT, required)
Read‑only:
- `id` GUID

#### 7.2 Потребители (`consumers`)
Таблица (editable):
- `name` (TEXT, required)
- `load_ref_type` (enum `RTM_PANEL|RTM_ROW|MANUAL`)
- `load_ref_id` (TEXT, required):
  - если `RTM_PANEL`: выбрать `panel_id` из `panels`
  - если `RTM_ROW`: выбрать `rtm_rows.id` (в текущем calc_core агрегация `RTM_ROW` не поддержана; UI должен пометить как “не рассчитывается” и/или запретить этот тип в MVP v0.1)
  - если `MANUAL`: можно ставить `load_ref_id` = `consumer_id` или любой GUID (требование схемы: NOT NULL), UI должен заполнять автоматически.
- `notes` (TEXT, optional)

Поля MANUAL (editable только если `load_ref_type='MANUAL'`):
- `p_kw`, `q_kvar`, `s_kva`, `i_a` (REAL, required for MANUAL; иначе должны быть NULL)

#### 7.3 Питания (`consumer_feeds`)
Таблица (editable):
- `consumer_id` (FK, выбор из consumers)
- `bus_section_id` (FK, выбор из bus_sections)
- `feed_role` (enum `NORMAL|RESERVE`)

Валидации/предупреждения:
- Для каждого `consumer_id` допускается не более одного feed на роль (иначе агрегация выдаст ошибку; UI должен предотвращать дубль).
- Предупреждать, если у потребителя нет `NORMAL` feed (агрегация будет пропускать и печатать WARNING).

#### 7.4 Итоги секций (`section_calc`)
Read‑only таблица/вид:
- `bus_section_name`
- `mode` (`NORMAL|RESERVE`)
- `p_kw`, `q_kvar`, `s_kva`, `i_a`, `updated_at`

Кнопка:
- **Агрегировать по секциям**:
  - запускать `calc_core.section_aggregation.calc_section_loads` (или `tools/run_calc.py --calc-sections --sections-mode ...`)
  - режимы: переключатель `NORMAL/RESERVE`

Актуальность:
- Показывать статус `OK/STALE/NO_CALC/UNKNOWN` по правилам раздела **5) UX‑правила → Актуальность расчётов** (отдельно для `NORMAL` и `RESERVE`).
- При `STALE/NO_CALC/UNKNOWN` кнопка “Агрегировать по секциям” доступна и выделена как рекомендуемая.

### 8. Экспорт (JSON/CSV для DWG)

Экспорт НЕ должен изменять БД.

#### 8.1 JSON payload v0.4
- Кнопка “Экспортировать JSON payload”
- Проверки перед запуском:
  - наличие `rtm_panel_calc` для `panel_id` (обязательное условие; иначе экспорт падает по контракту)
  - статус РТМ `OK` (если `STALE/UNKNOWN` — требуется явное подтверждение “Экспортировать несмотря на неактуальность”)
- Параметры:
  - путь вывода
- Реализация требования:
  - использовать read‑only URI `file:...?...mode=ro` как в `tools/export_payload.py`

#### 8.2 CSV атрибутов v0.5
- Кнопка “Экспортировать CSV атрибутов”
- Параметры:
  - путь к mapping (по умолчанию `dwg/mapping_v0_5.yaml`, **только чтение**)
  - выходная директория
 - Проверки перед запуском:
   - статус РТМ `OK` (если `STALE/UNKNOWN` — требуется явное подтверждение “Экспортировать несмотря на неактуальность”)
- UI должен показывать:
  - какие CSV будут созданы (`attrs_panel.csv`, `attrs_circuits.csv`, `attrs_sections.csv`)
  - краткий отчёт: сколько строк записано в каждом файле

### 9. Администрирование (опасная зона)

Только в режиме EDIT + дополнительное подтверждение.

Функции:
- Удаление щита (`panels`) с каскадом (показывать, что удалятся зависимые строки).
- Массовая очистка расчётных таблиц для щита:
  - `rtm_row_calc`, `rtm_panel_calc`, `circuit_calc`, `section_calc`, `panel_phase_calc`
  - (цель: принудить “пересчитать заново”)
- “Сделать backup DB перед операцией” (копирование файла SQLite).

## 5) UX‑правила (цвет, предупреждения, блокировки)

### Цвет/статусы (единые бейджи)
- **Зелёный (OK)**: расчётные данные есть и проходят базовые проверки.
- **Оранжевый (STALE)**: ввод изменён после `updated_at` расчёта — требуется пересчёт.
- **Жёлтый (UNKNOWN)**:
  - нет данных о последнем изменении ввода (`ui_input_meta` отсутствует/не заполнен)
  - БД изменена вне UI
  - `ki` вне \([0.10..0.80]\) (будет clamp)
  - ΔU: метод `...MAX_SECTION`
- **Красный (NO_CALC / ERROR)**:
  - отсутствуют обязательные расчётные строки при наличии входа (например нет `rtm_panel_calc`)
  - нарушена валидация ввода (тип/диапазон/enum)
  - экспорт невозможен по контракту

### Где предупреждать, где блокировать
- **Блокировать**:
  - экспорт JSON/CSV, если нет `rtm_panel_calc` (контракт DWG payload v0.4) **или** статус РТМ `STALE/UNKNOWN` (без явного подтверждения).
  - “Рассчитать ΔU”, если нет валидного `panels.u_ph_v`.
  - сохранение строки РТМ, если `phase_mode='FIXED'` и `phase_fixed` пустой (и наоборот).
- **Не блокировать, но предупреждать**:
  - `ki` вне диапазона clamp (расчёт исправит).
  - отсутствие `circuit_calc` (экспорт payload допускает `NO_CALC`).
  - отсутствие `section_calc` для некоторых режимов.
  - `STALE/UNKNOWN` — показывать предупреждение и кнопку “Пересчитать”, но не блокировать просмотр.

### Read-only по умолчанию
- По умолчанию UI открывается в режиме **READ_ONLY**.
- Переключение в **EDIT** требует явного действия и показывает предупреждение “вы меняете БД”.

### Актуальность расчётов (stale status) — **обязательное поведение**

#### 5.0. Визуальное отображение статуса
- На каждой странице подсистемы (РТМ, ΔU, Секции) показывать **бейдж статуса** в заголовке.
- Бейдж всегда сопровождается **tooltip** с причиной статуса и временем:
  - `calc_updated_at`
  - `last_input_at` (локальный) и `last_input_at_global` (если применимо)
  - краткая причина (`NO_CALC`, `STALE`, `UNKNOWN`, `OK`)
- Рядом с бейджем — кнопка **“Пересчитать”**, активна при `STALE/NO_CALC/UNKNOWN`.

#### 5.1. DB‑backed механизм отслеживания изменений ввода (без формул)
UI **не вычисляет** формулы. Он **только сравнивает** время последнего изменения ввода с `updated_at` в calc‑таблицах.

Минимальный механизм (MVP‑UI v0.1):
- Создать (если отсутствует) служебную таблицу UI в той же БД:
  - `ui_input_meta(panel_id TEXT, subsystem TEXT, last_input_at TEXT, last_input_source TEXT, last_input_note TEXT, PRIMARY KEY(panel_id, subsystem))`
  - `panel_id='*'` используется для “глобальных” изменений (например `cable_sections`).
- Если UI подключён в READ_ONLY и таблицы нет — статусы показываются как `UNKNOWN` до переключения в EDIT и инициализации.
- При **каждом** сохранении ввода в UI — в **той же транзакции** обновлять `ui_input_meta`:
  - `INSERT ... ON CONFLICT(panel_id, subsystem) DO UPDATE SET last_input_at = <now>, last_input_source = 'UI'`
- Допустимая альтернатива (если внедрение триггеров допустимо): UI может создать `CREATE TRIGGER IF NOT EXISTS ...` на входных таблицах, которые поддерживают `ui_input_meta` автоматически. Это не требует миграций и не трогает `*_calc`.

#### 5.2. Какие изменения считаются “вводом” (по подсистемам)
Подсистемы и входные таблицы (всё в разрезе `panel_id`):
- **RTM**: любые изменения в `rtm_rows` и/или `panels` (без попытки “угадать” влияющие поля).
- **PHASE** (фазировка 1PH): любые изменения в `rtm_rows` и/или `panels`.  
  Статус показывается только если `panels.system_type='1PH'` (для 3PH скрыть).
- **DU (Цепи)**: любые изменения в `circuits` и/или `panels` (включая лимиты ΔU и напряжение).  
  Глобально: изменения `cable_sections` → обновить `ui_input_meta` с `panel_id='*'`, `subsystem='DU'`.
- **SECTIONS**: любые изменения в `bus_sections`, `consumers`, `consumer_feeds`.  
  Если есть потребители с `load_ref_type in ('RTM_PANEL','RTM_ROW')`, то обновление РТМ делает секции потенциально неактуальными.

#### 5.3. Правила статусов (OK/STALE/NO_CALC/UNKNOWN)
Статус вычисляется отдельно для каждой подсистемы на выбранном `panel_id`.

Обозначения:
- `last_input_at(panel, subsystem)` — из `ui_input_meta` (если есть).
- `last_input_at_global(subsystem)` — строка `panel_id='*'` (если есть).
- `effective_input_at = max(last_input_at, last_input_at_global)` (если существует).
- `calc_updated_at`:
  - RTM → `rtm_panel_calc.updated_at` (одна строка).
  - PHASE → `panel_phase_calc.updated_at` (одна строка, только для 1PH).
  - DU → минимальный `circuit_calc.updated_at` по всем цепям в панели.
  - SECTIONS → минимальный `section_calc.updated_at` по всем секциям в выбранном `mode`.

Правила:
- **NO_CALC**:
  - RTM: есть `rtm_rows`, но нет `rtm_panel_calc` **или** есть строки `rtm_rows` без `rtm_row_calc`.
  - PHASE: `system_type='1PH'`, есть `rtm_rows`, и нет `panel_phase_calc`.
  - DU: есть `circuits`, но число строк в `circuit_calc` меньше числа `circuits`.
  - SECTIONS: есть `bus_sections`, но число строк в `section_calc` (по mode) меньше числа `bus_sections`.
- **STALE**:
  - есть calc‑данные, и `effective_input_at` существует, и `calc_updated_at < effective_input_at`.
  - для SECTIONS дополнительно: если есть потребители с `load_ref_type in ('RTM_PANEL','RTM_ROW')` и `rtm_panel_calc.updated_at > section_calc.updated_at`, то `STALE`.
- **OK**:
  - calc‑данные есть и `calc_updated_at >= effective_input_at`, либо входных строк нет (ничего рассчитывать).
- **UNKNOWN**:
  - `ui_input_meta` отсутствует/не заполнен для подсистемы **или** UI обнаружил внешние изменения БД (см. 5.4).

#### 5.4. Внешние правки БД (fallback)
Если БД изменялась вне UI, UI **не может гарантировать** актуальность:
- UI должен проверять “внешние изменения” по `PRAGMA data_version` и/или `mtime` файла БД.
- Если данные изменились, а UI **не** инициировал запись:
  - пометить соответствующие подсистемы статусом `UNKNOWN`;
  - показать баннер “БД была изменена вне UI — актуальность расчётов не гарантирована. Рекомендуется пересчитать.”
  - кнопка “Пересчитать” доступна сразу.

## 6) “Удобно как Excel”: требования

### Табличные операции
- **Фильтры** по основным колонкам (имя, phases, phase_mode, load_kind, material, mode).
- **Сортировка** по имени и по числовым полям.
- **Поиск** по подстроке в `name`.
- **Закрепление** (freeze) ключевых колонок:
  - в РТМ‑таблице — `name`, `n`, `pn_kw`, `ki`
  - в цепях — `name`, `length_m`, `i_calc_a`
- **Копипаст/массовый ввод**:
  - вставка из Excel/CSV в таблицу `rtm_rows` и `circuits`
  - массовое применение значения в выделенный диапазон (например `cos_phi`)

### Итоговые строки / агрегаты
- Внизу РТМ‑таблицы показывать:
  - суммы по вводным/промежуточным полям (по данным таблицы)
  - расчётные итоги из `rtm_panel_calc` (истина)
- В цепях показывать:
  - количество цепей `OK/NO_CALC`
  - максимум `du_pct`, долю превышений лимита

### Непрерывная валидация
- Ошибки валидации должны быть видны **до** нажатия “Сохранить”.
- При наличии ошибок “Сохранить” и “Пересчитать” блокируются (или требуют “сохранить только валидные строки” — в MVP лучше блокировать полностью).

## 7) Безопасность данных

### Транзакции и атомарность
- Любые изменения ввода (`panels`, `rtm_rows`, `circuits`, `bus_sections`, `consumers`, `consumer_feeds`) — **только в транзакции**:
  - собрать изменения в UI (dirty state)
  - выполнить `BEGIN` → применить batch upsert/delete → `COMMIT`
  - при ошибке: `ROLLBACK`, показать сообщение с контекстом
- В **той же транзакции** обновлять `ui_input_meta` (см. правила актуальности), чтобы staleness работал детерминированно.

### Подтверждение удаления
- Удаление: двойное подтверждение:
  - чекбокс + ввод “DELETE”
  - показ каскадных последствий (кол-во строк в зависимых таблицах)

### Автопроверки перед расчётом/экспортом
- Перед расчётом РТМ:
  - проверка валидности всех строк `rtm_rows` для `panel_id`
  - проверка напряжений в `panels` (в зависимости от system_type)
- Перед расчётом ΔU:
  - `u_ph_v` валидно
  - `cable_sections` не пуст (если пуст — предложить seed стандартных сечений)
- Перед экспортом:
  - `rtm_panel_calc` существует (обязательное)
  - (опц.) предупреждать, если есть `circuits` без `circuit_calc` (экспорт разрешён)

### Минимум “возможностей сломать БД”
- Запрет редактирования GUID/PK/FK напрямую (только выбор из справочников).
- Запрет прямого редактирования `*_calc` таблиц.
- Переключатель EDIT только после явного согласия.
- Экспорт выполняется через read‑only соединение.
- (Опционально) “сделать backup DB” перед массовыми операциями.

## 8) MVP список

### UI v0.1 (обязательное)
- Подключение к БД + проверка миграций.
- Список щитов (`panels`) + выбор активного щита.
- Служебная таблица `ui_input_meta` (создание при необходимости) и расчёт статусов `OK/STALE/NO_CALC/UNKNOWN`.
- **РТМ таблица нагрузок (Excel‑экран)**:
  - редактирование `rtm_rows`
  - отображение `rtm_row_calc` и итогов `rtm_panel_calc`
  - кнопка “Пересчитать РТМ”
  - индикаторы `OK/STALE/NO_CALC/UNKNOWN` (через `ui_input_meta`)
- Экспорт:
  - JSON payload v0.4
  - CSV атрибутов v0.5 (read‑only mapping `dwg/mapping_v0_5.yaml`)
- “Мастер добавления” (минимально жизнеспособный):
  - создать щит → добавить строки РТМ → пересчитать → экспорт
- Минимальная “опасная зона”:
  - удалить строку РТМ с подтверждением
  - удалить щит с подтверждением

### UI v0.2 (желательное)
- Полноценные страницы:
  - Цепи ΔU: редактирование `circuits` + расчёт `circuit_calc` + подсветка превышений
  - Секции/потребители: `bus_sections` + `consumers` + `consumer_feeds` + агрегация в `section_calc`
- Расширение индикатора актуальности:
  - учёт “грязного состояния” (несохранённые изменения)
  - гибкая детализация по подсистемам и режимам
- Импорт из Excel/CSV:
  - загрузка строк РТМ и цепей из CSV (предпросмотр + валидация + транзакционная запись)
- Журнал операций UI (локально в файле/в памяти; без обязательной DB‑схемы):
  - кто/когда нажал “Пересчитать”, что экспортировал
- Режим “только расчёты/экспорт”:
  - UI подключается к БД в read‑only и разрешает только “посчитать” через отдельную копию БД или отдельный workflow
- (Если проект решит расширять схему) добавить `updated_at` к входным таблицам или `calc_runs` для точного контроля актуальности (это требует отдельного ADR/миграции и не входит в v0.1).

