# VOLTAGE_DROP — контракт расчёта ΔU и подбора сечения (ГОСТ Р 50571.5.52-2011, Прил. G)

Этот документ фиксирует **жёсткий контракт** расчёта падения напряжения \(\Delta U\) и подбора минимального
сечения кабеля по \(\Delta U\) для MVP-0.2.

## Принципы

- **DB = истина**: вход хранится в `circuits`, результаты — в `circuit_calc`.
- **CalcCore не зависит от CLI**: расчёт реализуется в `calc_core/*`.
- **DWG = только рендер**: расчёт не зависит от AutoCAD/DWG.
- **Никаких выдуманных констант**: используются значения из Приложения G (справочное).
- \(\Delta U\%\) считается относительно \(U_0\) (фаза‑нейтраль).

## Источники данных (SQLite)

### Ввод

- `panels.u_ph_v` — \(U_0\) (В), фазное напряжение (фаза‑нейтраль)
- `panels.du_limit_lighting_pct` — базовый лимит \(\Delta U\%\) для освещения (по умолчанию 3.0)
- `panels.du_limit_other_pct` — базовый лимит \(\Delta U\%\) для прочих (по умолчанию 5.0)

- `circuits.length_m` — длина линии \(L\) (м)
- `circuits.material` — материал (`CU`/`AL`) для выбора \(\rho\)
- `circuits.cos_phi` — \(\cos\varphi\)
- `circuits.phases` — 1 или 3 (для выбора коэффициента \(b\))
- `circuits.unbalance_mode` — `NORMAL`/`FULL_UNBALANCED` (для выбора \(b\))
- `circuits.load_kind` — `LIGHTING`/`OTHER` (для выбора лимита)
- `circuits.i_calc_a` — расчётный ток \(I\) (А), задаётся входом (MVP-решение)

### Справочник сечений

- `cable_sections(s_mm2)` — допустимые кандидаты сечения \(S\) (мм²), упорядочиваются по возрастанию

### Результаты

- `circuit_calc` — рассчитанные `du_v`, `du_pct`, применённый лимит, выбранное сечение, метод, `updated_at`

## Константы (Приложение G)

- \(\rho_{Cu} = 0.0225\) Ом·мм²/м (включая коэффициент 1.25×)
- \(\rho_{Al} = 0.036\) Ом·мм²/м (включая коэффициент 1.25×)
- \(X = 0.08\) мОм/м \(= 0.00008\) Ом/м

## Вычисления

### 1) \(\sin\varphi\)

\[
\sin\varphi = \sqrt{1 - \cos^2\varphi}
\]

Требование: `cos_phi` должен быть в диапазоне \([0, 1]\). Вне диапазона — ошибка (не “чинить”).

### 2) Коэффициент \(b\) (1/2)

В MVP-0.2:

- если `circuits.phases == 3` и `circuits.unbalance_mode == 'NORMAL'` → \(b = 1\)
- иначе → \(b = 2\)

Т.е.:
- 1-ф линии: \(b=2\)
- 3-ф FULL_UNBALANCED: трактуется как 1-ф по \(\Delta U\) (\(b=2\))

### 3) Эффективный лимит \(\Delta U\%\) при \(L > 100\) м

Базовый лимит:
- `LIGHTING` → `panels.du_limit_lighting_pct`
- `OTHER` → `panels.du_limit_other_pct`

Если \(L > 100\) м, допустимый \(\Delta U\%\) увеличивается:

\[
add\_{pct} = \min(0.005 \cdot (L - 100), 0.5)
\]
\[
\Delta U\_{limit,pct} = \Delta U\_{base,pct} + add\_{pct}
\]

### 4) \(\Delta U\) (В)

Для кандидата сечения \(S\) (мм²):

\[
\Delta U = b \cdot \left( \rho \cdot \frac{L}{S}\cdot \cos\varphi + X \cdot L \cdot \sin\varphi \right)\cdot I
\]

где:
- \(L\) — `length_m` (м)
- \(S\) — `s_mm2` (мм²)
- \(I\) — `i_calc_a` (А)
- \(X\) — 0.00008 Ом/м
- \(\rho\) выбирается по `material`:
  - `CU` → 0.0225 Ом·мм²/м
  - `AL` → 0.036 Ом·мм²/м

### 5) \(\Delta U\%\)

\[
\Delta U\% = 100 \cdot \frac{\Delta U}{U_0}
\]

где \(U_0 = panels.u\_ph\_v\).

### 6) Подбор минимального сечения по \(\Delta U\%\)

Алгоритм:

- получить список `S` из `cable_sections` по возрастанию
- для каждого `S` посчитать \(\Delta U\%\)
- выбрать **первое** `S`, где \(\Delta U\% \le \Delta U\_{limit,pct}\)
- если ни одно `S` не удовлетворяет лимиту — выбрать максимальное `S` и отметить метод/статус в `circuit_calc.method`

## Выход/запись в БД

Результат расчёта должен быть записан в `circuit_calc` (upsert по `circuit_id`) с полями:

- `i_calc_a` (как во входе)
- `du_v`
- `du_pct`
- `du_limit_pct` (с учётом правила \(L>100\))
- `s_mm2_selected`
- `method` (например `GOST_R_50571_5_52_2011_APP_G`)
- `updated_at` (ISO8601 UTC)

