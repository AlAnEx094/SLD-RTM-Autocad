# QA_ASSISTANT TASK — feature/qa-tests

ROLE: QA_ASSISTANT  
BRANCH: `feature/qa-tests` (создать изменения и коммиты только здесь)  
SCOPE (разрешено менять): `tests/*`  
SCOPE (запрещено менять): `db/*`, `calc_core/*`, `tools/*`, `docs/*`, `cad_adapter/*`

## Контекст

В baseline сейчас `pytest -q` падает по причинам:

1) `db/seed_kr_table.sql` минимальный и не покрывает ожидания старых тестов (например `ki=0.10` и интерполяционные точки).
2) Smoke тест вставляет панель в `panels` без `system_type`, а в схеме `system_type NOT NULL`.
3) `calc_core/tools` будут приведены к схеме в ветке `feature/calc-core` (другим агентом).

## Цель

Сделать тесты **устойчивыми к минимальному seed** и актуальной схеме:

- Тестировать **контракт поведения**, а не конкретные “табличные числа”, если они EXAMPLE.
- Использовать только точки, которые гарантированы минимальным seed (после db-layer изменений: `ki=0.10/0.60/0.70/0.80` для `ne=4`).

## Что нужно сделать

### A) `tests/test_kr_resolver.py`

- Обновить тесты так, чтобы они:
  - проверяли clamp:
    - `ki > 0.80` -> используется `0.80` и возвращается **табличное значение из БД**
    - `ki < 0.10` -> используется `0.10` и возвращается **табличное значение из БД**
  - проверяли `ne_tab` округлением вверх (например `ne=3` -> `ne_tab=4`)
  - проверяли линейную интерполяцию по `Ki` **между `0.70` и `0.80`**, например на `ki=0.71`

Важно: если значения `kr` в seed помечены как EXAMPLE, тесты не должны “знать” их заранее.
Лучший паттерн: **читать `kr` из БД** и вычислять ожидаемое значение по формуле интерполяции.

### B) `tests/test_rtm_smoke.py`

Привести к актуальной схеме (после фикса calc-core):

- при вставке `panels` обязательно указывать:
  - `system_type` (`'3PH'` или `'1PH'`)
  - напряжения (`u_ll_v`, `u_ph_v`) согласованно
- создавать входные строки в `rtm_rows`, а не `rtm_input_rows`
- smoke должен проверять, что после запуска расчёта:
  - есть строки в `rtm_row_calc` для `rtm_rows`
  - есть строка `rtm_panel_calc` для `panel_id`

### C) Phase balance тест

Добавлять `tests/test_phase_balance.py` **только если** существует `calc_core/phase_balance.py`
и он реально пишет в `panel_phase_calc`. Если файла нет — не добавлять тест.

## Git workflow

1) `git checkout feature/qa-tests`
2) Правки только в `tests/*`
3) `git add tests`
4) `git commit -m "test: align Kr and RTM smoke tests to minimal seed and schema"`

## Проверка

- Запусти `python3 -m pytest -q` в ветке и добейся зелёного (после того, как db-layer и calc-core изменения смержены/подтянуты, если нужно).

